<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guernsey Roadworks</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root { --bg:#0b1020; --panel:#11162a; --muted:#7d8aa5; --text:#e7ecf7; --accent:#5cc8ff; --border:#1e2a4a; --card:#0f1530; --radius:16px; }
    *, *::before, *::after { box-sizing: border-box; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* Two fixed columns so map width never changes (desktop) */
    .wrap{display:grid;grid-template-columns:360px 1fr;height:100dvh}

    /* Sidebar spacing widened a touch */
    .sidebar{
      min-height:0;             /* you already have this */
      overflow:auto;            /* NEW: enable scroll in the sidebar */
      -webkit-overflow-scrolling: touch;
    }

    /* Ensure the map column can shrink without forcing page overflow */
    main{ min-height:0; }

    h1{margin:0 0 4px;font-size:18px}
    .muted{color:var(--muted);font-size:12px}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;                       /* was 14px */
    }

    label{font-size:12px;color:var(--muted)}
    input,select{width:100%;background:#0a0f24;color:var(--text);padding:10px 12px;border:1px solid var(--border);border-radius:12px;outline:none}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px} /* was 12px */
    .grid.grid-2-compact{grid-template-columns:1fr auto;align-items:start;gap:14px}

    /* Right-side button stack next to Bus routes */
    .btn-stack{display:grid;gap:8px}
    .btn-stack .small{padding:6px 10px;font-size:12px;white-space:nowrap}

    button{background:var(--accent);border:0;color:#00121f;padding:10px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    button.small{padding:6px 10px;font-size:12px}
    #map{height:100%}

    /* Legend */
    .legend{
      position:absolute; right:14px; top:14px; z-index:1000;
      background:#ffffff; color:#0b1020; border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      border:1px solid #dfe7f3; padding:10px 12px; font-size:12px;
      pointer-events:none;
    }
    .legend .row{display:flex; align-items:center; gap:8px; margin:4px 0}
    .swatch{width:18px;height:3px;border-radius:2px;display:inline-block}
    .swatch.red{background:#d73027}
    .swatch.orange{background:#fdae61}
    .swatch.yellow{background:#fee08b;border:1px solid #e6d06f}
    .swatch.blue{background:#1e6cff}

    /* Results card owns its height; only the list scrolls */
    .results-card{
      height:60vh; min-height:0;
      display:block;             /* not flex */
      overflow:hidden;           /* prevent the card itself from scrolling */
    }
    @media (max-width: 900px){ .results-card{ height:70vh; } }

    /* Make the <details> a grid so the list gets the remaining space */
    #results{
      display:grid;
      grid-template-rows: auto auto 1fr;  /* summary, toolbar, list */
      min-height:0; height:100%;
    }

    /* Keep the summary styles you had */
    #results>summary{
      position:sticky; top:0; z-index:2; background:var(--card);
      border-bottom:1px solid var(--border); padding-bottom:6px;
      cursor:pointer; font-weight:600;
    }
    #results>summary::-webkit-details-marker{display:none}
    #results>summary::marker{content:""}
    #results>summary::before{content:"▸";margin-right:6px}
    #results[open]>summary::before{content:"▾"}

    /* Toolbar sits under the summary; no need to be sticky for this fix */
    .results-toolbar{
      background:var(--card); border-bottom:1px solid var(--border);
      padding:6px 0; display:flex; justify-content:flex-end; gap:8px;
    }

    /* The list is the scroll container */
    #list{
      min-height:0;
      overflow-y:auto !important;
      display:grid; gap:8px;
      -webkit-overflow-scrolling:touch;
    }

    .item{background:#0b1330;border:1px solid var(--border);border-radius:14px;padding:12px;cursor:pointer}
    .item:hover{outline:2px solid #2646ff33}
    .item h3{margin:0 0 6px;font-size:14px}
    .pill{font-size:11px;border:1px solid transparent;border-radius:999px;padding:3px 8px;background:#e8f1ff;color:#00121f;margin-right:6px;display:inline-block;margin-top:6px}

    .footer{font-size:12px;color:var(--muted)}
    a{color:var(--accent);text-decoration:none}

    html { scrollbar-gutter: stable both-edges; }
    body { overflow: hidden; }
    #results { overflow-anchor: none; }

    /* Make sure our divIcon wrapper behaves */
    .tm-icon{ display:block; line-height:0; background:transparent; border:0; }

    /* Sign markers (divIcon) */
    .sign{
      width:28px; height:28px; border-radius:50%;
      display:grid; place-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,.35);
    }
    .sign.noentry{ background:#d73027; border:2px solid #9c1f1c; }

    /* One-way: white up arrow on blue circle */
    .sign.oneway{
      background:#2f74ff;
      border:2px solid #214ea8;
      border-radius:50%;
      width:28px; height:28px;
      display:grid; place-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,.35);
    }
    .sign.oneway .arrow-up{
      position:relative;
      width:0; height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-bottom:10px solid #fff; /* triangle tip */
    }
    .sign.oneway .arrow-up::before{
      content:"";
      position:absolute;
      left:50%; transform:translateX(-50%);
      top:10px; width:4px; height:8px;
      background:#fff;               /* vertical shaft */
    }

    .sign.clock{   background:#ffd44d; border:2px solid #b59420; }
    .sign.works{   background:#ff7f27; border:2px solid #b2561b; }
    .sign .bar{   width:16px; height:4px; background:#fff; border-radius:2px; }

    /* Mobile slide-in sidebar */
    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; }
      .sidebar {
        position: fixed;
        inset: 0 auto 0 0;
        width: 86vw; max-width: 360px;
        transform: translateX(-100%);
        transition: transform .25s ease;
        z-index: 1001;
      }
      .sidebar.open { transform: translateX(0); }

      .menu-btn {
        position: fixed; left: 12px; top: 12px; z-index: 1002;
        background: var(--accent); color: #00121f;
        border: 0; border-radius: 12px; padding: 10px 12px; font-weight: 700;
        box-shadow: 0 6px 18px rgba(0,0,0,.25);
      }

      .backdrop {
        position: fixed; inset: 0; z-index: 1000;
        background: rgba(0,0,0,.35);
      }
    }

    /* Popup text size & spacing */
    .leaflet-popup-content-wrapper { padding: 14px 14px 12px; }
    .leaflet-popup-content { 
      font-size: 14.5px;     /* was ~12–13px by default */
      line-height: 1.4;
    }
    .leaflet-popup-content b { font-weight: 600; }   /* labels like “Traffic management:” */
    .leaflet-popup-tip { width: 14px; height: 14px; } /* optional: scale the tip a touch */

    /* Top-right legend */
    .legend { 
      font-size: 16px;     /* was 12px in your code */
      padding: 12px 14px;    /* a bit more breathing room */
    }
    .legend .row { gap: 10px; }

    /* (Optional) a tiny bump on small screens */
    @media (max-width: 900px) {
      .leaflet-popup-content { font-size: 15px; }
      .legend { font-size: 14px; }
    }

    .brand-row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .brand-btn{
      display:inline-grid; place-items:center;
      width:55px; height:55px; border-radius:5px;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .brand-btn img{ display:block; height:55px; width:55px; }
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="sidebar" id="sidebar">
      <div class="brand-row">
        <h1>Guernsey Roadworks</h1>
        <a class="brand-btn" href="https://thequarry.media" target="_blank" rel="noopener" aria-label="Back to The Quarry Media">
          <img src="assets/thequarry-logo.svg" alt="The Quarry Media" />
        </a>
      </div>

      <!-- Filters card -->
      <div class="card">
        <div style="display:grid;gap:10px">
          <label for="q">Search</label>
          <input id="q" type="text" placeholder="e.g. Rue a l'Or, trenching, 81" />

          <div class="grid">
            <div>
              <label for="activeDate">Active on</label>
              <input id="activeDate" type="date" />
              <div class="muted" style="margin-top:4px">If you set a date, “Window” is ignored.</div>
            </div>
            <div>
              <label for="window">Window</label>
              <select id="window">
                <option value="today" selected>Today only</option>
                <option value="7">Next 7 days</option>
                <option value="14">Next 14 days</option>
                <option value="30">Next 30 days</option>
                <option value="90">Next 90 days</option>
                <option value="all">All</option>
              </select>
            </div>
          </div>

          <div class="grid grid-2-compact">
            <div>
              <label for="route">Bus routes</label>
              <select id="route" multiple></select>
            </div>
            <div class="btn-stack">
              <button id="export" class="ghost small">Export view (CSV)</button>
              <button id="reset"  class="ghost small">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Results card -->
      <div class="card results-card">
        <details id="results" open>
          <summary>Results (<span id="shownCount">0</span> of <span id="totalCount">0</span>)</summary>
          <div class="results-toolbar">
            <button id="toggleAll" class="ghost small" aria-pressed="false">Show all results</button>
          </div>
          <div id="list"></div>
        </details>
      </div>

      <div class="footer">Data © States of Guernsey. Map © OpenStreetMap.</div>
    </aside>

    <main style="position:relative">
      <div id="map"></div>
      <div class="legend">
        <div class="row"><span class="swatch red"></span> Road closure</div>
        <div class="row"><span class="swatch orange"></span> One way</div>
        <div class="row"><span class="swatch yellow"></span> Time-restricted / Peak</div>
        <div class="row"><span class="swatch blue"></span> Other</div>
      </div>
    </main>
  </div>

  <!-- Mobile menu button + backdrop -->
  <button id="menuBtn" aria-expanded="false" aria-controls="sidebar" class="menu-btn" title="Menu">☰</button>
  <div id="backdrop" class="backdrop" hidden></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
  <script>
    // --- Map setup (bounded to island, no world wrap) ---
    const ISLAND_BOUNDS = L.latLngBounds([49.36,-2.70],[49.54,-2.45]);
    const map = L.map('map', {
      center:[49.455,-2.58],
      zoom:12,
      maxBounds: ISLAND_BOUNDS,
      maxBoundsViscosity: 0.8,
      worldCopyJump: false
    });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution:'© OpenStreetMap & CARTO',
      subdomains:'abcd',
      maxZoom:20,
      noWrap:true
    }).addTo(map);

    // Keep sidebar’s scroll/touch/wheel from moving the map
    const sidebar = document.getElementById('sidebar');
    ['wheel','mousewheel','touchstart','touchmove','touchend','pointerdown','pointermove'].forEach(ev=>{
      sidebar.addEventListener(ev, e => e.stopPropagation(), { passive:true });
    });
    L.DomEvent.disableScrollPropagation(sidebar);
    L.DomEvent.disableClickPropagation(sidebar);

    map.createPane('closures-lines');
    map.getPane('closures-lines').style.zIndex = 400;

    // Popups: keep on-screen and clear of the sidebar / top chrome
    const popupOpts = {
      autoClose:false, closeOnClick:false, autoPan:true, keepInView:true,
      autoPanPaddingTopLeft:[360+16,100],
      autoPanPaddingBottomRight:[20,40]
    };

    const cluster = L.markerClusterGroup({
      showCoverageOnHover:false, maxClusterRadius:36, zoomToBoundsOnClick:false
    }).addTo(map);
    cluster.on('clusterclick', e => e.layer.spiderfy());
    map.options.closePopupOnClick = false;

    // --- State ---
    const els = {
      q: document.getElementById('q'),
      activeDate: document.getElementById('activeDate'),
      window: document.getElementById('window'),
      route: document.getElementById('route'),
      reset: document.getElementById('reset'),
      exportBtn: document.getElementById('export'),
      list: document.getElementById('list'),
      shownCount: document.getElementById('shownCount'),
      totalCount: document.getElementById('totalCount'),
      results: document.getElementById('results'),
      toggleAll: document.getElementById('toggleAll'),
      menuBtn: document.getElementById('menuBtn'),
      backdrop: document.getElementById('backdrop'),
    };

    function resizeList(){
      const card = document.querySelector('.results-card');
      const res  = document.getElementById('results');
      const list = document.getElementById('list');
      if (!card || !res || !list) return;

      const summary  = res.querySelector('summary');
      const toolbar  = res.querySelector('.results-toolbar');

      const cardRect = card.getBoundingClientRect();
      const sumH     = summary ? summary.getBoundingClientRect().height : 0;
      const tbH      = toolbar ? toolbar.getBoundingClientRect().height : 0;

      const cs = getComputedStyle(card);
      const padV   = parseFloat(cs.paddingTop) + parseFloat(cs.paddingBottom);
      const bordV  = parseFloat(cs.borderTopWidth) + parseFloat(cs.borderBottomWidth);

      // A few extra pixels for grid gaps/borders so nothing gets clipped
      const spare = 12;

      const available = Math.max(
        0,
        Math.floor(cardRect.height - sumH - tbH - padV - bordV - spare)
      );

      list.style.minHeight = available + 'px';
      list.style.maxHeight = available + 'px';
      list.style.overflowY = 'auto';
    }

    // Prevent page scroll jump when <details> toggles; also freeze map view exactly
    const resSummary = els.results.querySelector('summary');
    let pageScrollY = window.scrollY;
    resSummary.addEventListener('mousedown', () => { pageScrollY = window.scrollY; }, { passive:true });
    els.results.addEventListener('toggle', () => {
      const openPopup = map._popup || null;
      if (openPopup) openPopup.options.autoPan = false;

      window.scrollTo({ top: pageScrollY, left: 0, behavior: 'auto' });

      const z = map.getZoom();
      const p = map.project(map.getCenter(), z);
      const freeze = () => {
        map.stop();
        map.invalidateSize({ animate:false });
        map.setView(map.unproject(p, z), z, { animate:false });
      };
      requestAnimationFrame(() => {
        freeze();
        requestAnimationFrame(() => {
          freeze();
          if (openPopup) openPopup.options.autoPan = true;
          resizeList();
        });
      });
    });

    // Mobile sidebar logic
    function isMobile(){ return window.matchMedia('(max-width: 900px)').matches; }
    function setSidebarOpen(open){
      if (!isMobile()) open = false; // force closed on desktop
      sidebar.classList.toggle('open', open);
      els.menuBtn.setAttribute('aria-expanded', String(open));
      els.backdrop.hidden = !open;
      if (open){
        map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable();
        map.boxZoom.disable(); map.keyboard.disable();
      } else {
        map.dragging.enable(); map.scrollWheelZoom.enable(); map.doubleClickZoom.enable();
        map.boxZoom.enable(); map.keyboard.enable();
      }
    }
    els.menuBtn.addEventListener('click', () => setSidebarOpen(!sidebar.classList.contains('open')));
    els.backdrop.addEventListener('click', () => setSidebarOpen(false));
    window.addEventListener('resize', () => { setSidebarOpen(false); requestAnimationFrame(resizeList); });

    function currentSidebarPadding(){
      const open = sidebar.classList.contains('open');
      return (isMobile() && !open) ? 0 : (sidebar.offsetWidth || 360);
    }

    // --- Data/state ---
    const todayISO = dayjs().format('YYYY-MM-DD');     // used for window-based filters
    els.activeDate.value = '';                         // start empty so Window is the default
    let features = [], lineFeatures = [], markers = [], linesLayer = L.layerGroup().addTo(map);
    let visibleFeatures = [], allowAutoFit = true;
    const featureToMarker = new WeakMap();
    const stripAccents = s => String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();

    // --- Load data ---
    Promise.all([
      fetch('data/closures.json?_=' + Date.now()).then(r => r.json()).catch(() => ({ type:'FeatureCollection', features: [] })),
      fetch('data/closures_lines.json?_=' + Date.now()).then(r => r.json()).catch(() => ({ type:'FeatureCollection', features: [] })),
    ]).then(([points, lines]) => {
      features = points.features || [];
      lineFeatures = lines.features || [];

      // routes selector
      const allRoutes = new Set();
      features.forEach(f => (f.properties.bus_routes || []).forEach(r => allRoutes.add(r)));
      [...allRoutes].sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}))
        .forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; els.route.appendChild(o); });

      // markers
      features.forEach(f => {
        if(!f.geometry || f.geometry.type !== 'Point') return;
        const [lng,lat] = f.geometry.coordinates;
        const m = L.marker([lat,lng], { icon: tmDivIcon(f.properties) }).bindPopup(renderPopup(f), popupOpts);
        markers.push({ marker: m, feature: f });
        featureToMarker.set(f, m);
        cluster.addLayer(m);
      });

      try { map.fitBounds(cluster.getBounds(), { padding:[20,20] }); } catch {}

      // Events
      els.q.addEventListener('input', applyFilters);
      els.route.addEventListener('change', applyFilters);

      // Mutually exclusive date/window:
      els.activeDate.addEventListener('change', () => {
        if (els.activeDate.value) {
          els.window.value = 'all';   // visually indicate window is ignored
          els.window.disabled = true;
        } else {
          els.window.disabled = false;
        }
        applyFilters();
      });
      els.window.addEventListener('change', () => {
        if (els.window.value !== 'all') {
          els.activeDate.value = '';
        }
        els.window.disabled = false;
        applyFilters();
      });

      els.reset.addEventListener('click', ()=>{
        els.q.value='';
        els.activeDate.value='';
        els.window.value='today';
        els.window.disabled = false;
        [...els.route.options].forEach(o => o.selected = false);
        allowAutoFit = true;
        map.closePopup();
        try { cluster.refreshClusters(); } catch {}
        applyFilters();
      });

      els.exportBtn.addEventListener('click', exportCsv);
      els.toggleAll.addEventListener('click', () => {
        showAll = !showAll;
        els.toggleAll.textContent = showAll ? 'Show top 3' : 'Show all results';
        els.toggleAll.setAttribute('aria-pressed', String(showAll));
        paintList();
        resizeList(); // re-render with new mode
      });

      // On small screens, default Window to "today"
      if (isMobile()) els.window.value = 'today';

      applyFilters();
      resizeList(); 
    });

    // --- Styles / icons ---
    function styleForTM(f){
      const t = stripAccents(f.properties.tm_type || '');
      if (t.includes('closure')) return { weight:3, opacity:0.95, color:'#d73027' };
      if (t.includes('one way')) return { weight:3, opacity:0.95, color:'#fdae61' };
      if (t.includes('peak') || t.includes('time')) return { weight:3, opacity:0.95, color:'#fee08b' };
      return { weight:3, opacity:0.95, color:'#1e6cff' };
    }
    function tmKind(p){
      const t = stripAccents((p?.tm_type || '').toLowerCase());
      if (t.includes('closure')) return 'closure';
      if (t.includes('one way') || t.includes('one-way')) return 'oneway';
      if (t.includes('peak') || t.includes('time')) return 'timerestricted';
      return 'other';
    }
    function tmDivIcon(p){
      const base = 'leaflet-div-icon tm-icon';
      const kind = tmKind(p);

      if (kind === 'closure') {
        return L.divIcon({
          className: base,
          html:`<div class="sign noentry"><div class="bar"></div></div>`,
          iconSize:[28,28],
          iconAnchor:[14,14]
        });
      }
      if (kind === 'oneway') {
        return L.divIcon({
          className: base,
          html:`<div class="sign oneway"><div class="arrow-up"></div></div>`,
          iconSize:[28,28],
          iconAnchor:[14,14]
        });
      }
      if (kind === 'timerestricted') {
        return L.divIcon({
          className: base,
          html:`<div class="sign clock">
            <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
              <circle cx="8" cy="8" r="7" fill="#fff"/>
              <rect x="7.5" y="4" width="1" height="5" fill="#0b1020"/>
              <rect x="8" y="8" width="4" height="1" fill="#0b1020" transform="rotate(45 8 8)"/>
            </svg>
          </div>`,
          iconSize:[28,28],
          iconAnchor:[14,14]
        });
      }
      return L.divIcon({
        className: base,
        html:`<div class="sign works">
          <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
            <path d="M8 2 L2 14 H14 Z" fill="#fff"/>
            <rect x="7" y="7" width="2" height="5" fill="#ff7f27"/>
          </svg>
        </div>`,
        iconSize:[28,28],
        iconAnchor:[14,14]
      });
    }

    // --- Filters + list (toggle: 3 vs all) ---
    const INITIAL_COUNT = 3;
    let renderPool = [];  // sorted, filtered features
    let showAll = false;

    function featureMatches(f, q, activeDate, windowVal, selectedRoutes){
      const p = f.properties || {};
      const s = p.start_date ? dayjs(p.start_date) : null;
      const e = p.end_date   ? dayjs(p.end_date)   : null;
      const start = s || e, end = e || s;

      // Date filtering (Active date takes precedence; otherwise window starting today)
      if (activeDate) {
        const d = dayjs(activeDate);
        if (start && end) {
          if (d.isBefore(start,'day') || d.isAfter(end,'day')) return false;
        }
      } else {
        const startW = dayjs(todayISO);
        if (windowVal === 'today') {
          const endW = startW;
          if (start && end) {
            if (end.isBefore(startW,'day') || start.isAfter(endW,'day')) return false;
          }
        } else if (windowVal !== 'all') {
          const days = parseInt(windowVal,10);
          const endW   = startW.add(days,'day');
          if (start && end) {
            if (end.isBefore(startW,'day') || start.isAfter(endW,'day')) return false;
          }
        }
      }

      // Routes
      if (selectedRoutes.length) {
        const routes = p.bus_routes || [];
        if(!routes.some(r => selectedRoutes.includes(r))) return false;
      }

      // Text
      const qv = stripAccents(q).trim();
      if (qv) {
        const hay = stripAccents([p.road, p.description, p.what, p.contractor, (p.bus_routes||[]).join(' ')].join(' '));
        if(!hay.includes(qv)) return false;
      }

      return true;
    }

    function renderList(items){
      renderPool = items.slice().sort((a,b)=>(a.properties.start_date||'').localeCompare(b.properties.start_date||''));
      paintList();
    }

    function paintList(){
      els.list.innerHTML = '';
      els.list.scrollTop = 0;  // reset on repaint
      const count = showAll ? renderPool.length : Math.min(INITIAL_COUNT, renderPool.length);

      for (let i = 0; i < count; i++){
        const f = renderPool[i], p = f.properties;
        const d1 = fmtDate(p.start_date), d2 = fmtDate(p.end_date || p.start_date);
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<h3>${escapeHtml(p.road||'Unknown road')}</h3>
                         <div class="pill">${d1} – ${d2}</div>
                         ${p.tm_type?`<span class="pill">${escapeHtml(p.tm_type)}</span>`:''}`;
        div.addEventListener('click', () => { allowAutoFit = false; focusItem(f); if (isMobile()) setSidebarOpen(false); });
        els.list.appendChild(div);
      }
      els.shownCount.textContent = count;
      els.totalCount.textContent = renderPool.length;
      els.toggleAll.textContent = showAll ? 'Show top 3' : 'Show all results';
      els.toggleAll.setAttribute('aria-pressed', String(showAll));
      requestAnimationFrame(resizeList);
    }

    function applyFilters(){
      const q = els.q.value.trim();
      const activeDate = els.activeDate.value;        // '' means not set
      const windowVal  = els.window.value;
      const selectedRoutes = [...els.route.selectedOptions].map(o=>o.value);

      visibleFeatures = features.filter(f => featureMatches(f, q, activeDate, windowVal, selectedRoutes));

      // update markers
      cluster.clearLayers();
      const bounds = [];
      for(const { marker, feature } of markers){
        if (visibleFeatures.includes(feature)) {
          cluster.addLayer(marker);
          bounds.push(marker.getLatLng());
        }
      }

      // rebuild lines
      linesLayer.clearLayers();
      const visibleLines = lineFeatures.filter(f => featureMatches(f, q, activeDate, windowVal, selectedRoutes));
      if(visibleLines.length){
        L.geoJSON({ type:'FeatureCollection', features: visibleLines }, {
          pane: 'closures-lines',
          style: styleForTM,
          onEachFeature: (f, layer) => layer.bindPopup(renderPopup(f), popupOpts)
        }).addTo(linesLayer);
      }

      if (allowAutoFit) {
        if (bounds.length) {
          const bb = L.latLngBounds(bounds).pad(0.05);
          const target = bb.overlaps(ISLAND_BOUNDS) ? bb : ISLAND_BOUNDS;
          map.fitBounds(target, { maxZoom: 15, padding: [20,20] });
        } else {
          map.fitBounds(ISLAND_BOUNDS, { padding: [20,20] });
        }
      }
      renderList(visibleFeatures);
    }

    // focus + popup nudge that respects sidebar state
    function focusItem(f){
      if (!f?.geometry) return;
      const [lng, lat] = f.geometry.coordinates;
      const m = featureToMarker.get(f);
      if (!m) return;

      allowAutoFit = false;

      cluster.zoomToShowLayer(m, () => {
        const target = L.latLng(lat, lng);
        const zNow = map.getZoom();
        const z = Math.max(14, Math.min(16, zNow < 14 ? 15 : zNow));
        map.setView(target, z, { animate: true });
        map.once('moveend', () => {
          m.openPopup();
          const sideW = currentSidebarPadding();
          try {
            if (map.panInside) {
              map.panInside(target, {
                paddingTopLeft: [sideW + 16, 100],
                paddingBottomRight: [20, 40],
              });
            }
          } catch {}
        });
      });
    }

    // Run once when the whole page (fonts, etc.) is ready
    window.addEventListener('load', () => {
      resizeList();
      // one extra turn of the event loop to catch any late layout
      setTimeout(resizeList, 0);
    });

    // If the browser exposes the Font Loading API, wait for fonts too
    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(() => requestAnimationFrame(resizeList));
    }

    // --- Popups / export ---
    function renderPopup(f){
      const p = f.properties || {};
      const road = escapeHtml(p.road || 'Unknown road');
      const range = `${fmtDate(p.start_date)} – ${fmtDate(p.end_date || p.start_date)}`;
      const desc = escapeHtml(p.description || p.what || 'No description supplied');
      const tm = p.tm_type ? `<div style="margin-top:6px"><b>Traffic management:</b> ${escapeHtml(p.tm_type)}</div>` : '';
      const routes = (Array.isArray(p.bus_routes) ? p.bus_routes : String(p.bus_routes||'').split(/[;,/\s]+/).filter(Boolean))
                      .map(r => `<span class="pill">${escapeHtml(r)}</span>`).join(' ');
      const contractor = p.contractor ? `<div class="muted" style="margin-top:6px">Contractor: ${escapeHtml(p.contractor)}</div>` : '';
      return `
        <div style="min-width:260px">
          <div style="font-weight:700;font-size:16px;margin-bottom:2px">${road}</div>
          <div class="muted" style="margin-bottom:8px">${range}</div>
          <div>${desc}</div>
          ${tm}
          ${routes ? `<div>${routes}</div>` : ``}
          ${contractor}
        </div>
      `;
    }

    function exportCsv(){
      const rows=[['road','start_date','end_date','tm_type','what','description','bus_routes','contractor','lat','lng']];
      visibleFeatures.forEach(f=>{
        const p=f.properties; const [lng,lat]=(f.geometry?.coordinates)||[null,null];
        rows.push([p.road||'',p.start_date||'',p.end_date||'',p.tm_type||'',p.what||'',p.description||'',(p.bus_routes||[]).join('|'),p.contractor||'',lat,lng]);
      });
      const csv = rows.map(r=>r.map(v=>String(v).replaceAll('"','""')).map(v=>`"${v}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='closures_export.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function fmtDate(iso){ return iso ? dayjs(iso).format('D MMM YYYY') : '—'; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  </script>
</body>
</html>